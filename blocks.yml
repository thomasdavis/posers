# Posers Motion Engine - Blocks Configuration
# Domain-driven validation for procedural VRM animations

name: "Posers Motion Engine"
root: "packages/motion-dsl/src/motions"

ai:
  provider: "openai"
  model: "gpt-4o-mini"

philosophy:
  - "Motions must be anatomically accurate and biomechanically sound"
  - "Every motion should utilize maximum bone engagement for realism"
  - "Transitions between motions must be fluid and seamless"
  - "Code must be deterministic - same seed produces same animation"
  - "Movements should feel organic through layered animation and secondary motion"
  - "All motions must gracefully handle missing optional bones"
  - "Performance is critical - updates must complete in under 2ms"
  - "Physics-based spring dynamics create natural acceleration curves"
  - "Micro-movements and noise add life to static poses"

domain:
  entities:
    motion_program:
      description: "A procedural animation program that updates VRM bone rotations each frame"
      fields:
        - meta
        - paramsSchema
        - init
        - update

    bone:
      description: "A VRM humanoid bone that can be rotated"
      fields:
        - name
        - rotation
        - worldPosition

    rig:
      description: "The HumanoidRig API for safe bone manipulation"
      fields:
        - setRotation
        - addRotation
        - hasBone
        - setHipsPositionOffset

    motion_context:
      description: "Runtime context passed to motion update functions"
      fields:
        - params
        - state
        - seed
        - target

  signals:
    bone_coverage:
      description: "How many bones are actively animated in a motion"
      extraction_hint: "Count unique bone names used in setRotation/addRotation calls"

    transition_smoothness:
      description: "Whether motion supports fluid start/stop"
      extraction_hint: "Look for blend weights, fade in/out, or state-based transitions"

    physics_realism:
      description: "Use of spring dynamics, secondary motion, noise"
      extraction_hint: "Look for spring, noise, secondary motion, follow-through patterns"

    anatomical_accuracy:
      description: "Biomechanically correct joint movements"
      extraction_hint: "Check joint rotation axes, rotation limits, natural movement patterns"

  measures:
    bone_count:
      constraints:
        - "Simple motions should use at least 10 bones"
        - "Complex motions should use at least 25 bones"
        - "Must include core bones: hips, spine, chest, neck, head"

    update_performance:
      constraints:
        - "Update function must complete in under 2ms"
        - "Avoid allocations in hot path"
        - "Use pre-computed values where possible"

    quaternion_validity:
      constraints:
        - "All quaternions must be normalized"
        - "No NaN or Infinity values allowed"
        - "Rotations must be within anatomical limits"

blocks:
  confident_stance:
    type: function
    description: "Power pose with subtle breathing and weight shifts - uses all available bones"
    path: "packages/motion-dsl/src/motions/confident-stance.ts"
    inputs:
      - name: rig
        type: entity.rig
        description: "VRM humanoid rig"
      - name: ctx
        type: entity.motion_context
        description: "Motion runtime context"
    outputs:
      - name: pose
        type: entity.motion_program
        measures: [bone_count, update_performance, quaternion_validity]
        constraints:
          - "Must animate spine chain for posture"
          - "Must include subtle breathing oscillation"
          - "Must add micro-movement noise layer"
          - "Should animate fingers if available"
          - "Should animate eyes if available"

  nervous_fidget:
    type: function
    description: "Anxiety-driven fidgeting with weight shifts and self-soothing gestures"
    path: "packages/motion-dsl/src/motions/nervous-fidget.ts"
    inputs:
      - name: rig
        type: entity.rig
      - name: ctx
        type: entity.motion_context
    outputs:
      - name: pose
        type: entity.motion_program
        measures: [bone_count, update_performance, quaternion_validity]
        constraints:
          - "Must show tension in shoulders and neck"
          - "Must include irregular weight shifting"
          - "Must animate hands/fingers for fidgeting"
          - "Should include rapid eye movement if available"
          - "Breathing should be shallow and faster"

  smoking_cigarette:
    type: function
    description: "Complete smoking animation with hand-to-mouth, inhale, exhale phases"
    path: "packages/motion-dsl/src/motions/smoking-cigarette.ts"
    inputs:
      - name: rig
        type: entity.rig
      - name: ctx
        type: entity.motion_context
    outputs:
      - name: pose
        type: entity.motion_program
        measures: [bone_count, update_performance, quaternion_validity]
        constraints:
          - "Must implement state machine: idle, bring_to_mouth, inhale, hold, exhale, lower, ash_tap"
          - "Must use precise finger positioning for cigarette grip"
          - "Must coordinate breathing with inhale/exhale phases"
          - "Must use spring physics for arm movement"
          - "Must include secondary motion on fingers"
          - "Should squint eyes during inhale if available"
          - "Should animate jaw during exhale if available"

  seductive_walk:
    type: function
    description: "Runway-style walk with exaggerated hip sway and fluid arm movement"
    path: "packages/motion-dsl/src/motions/seductive-walk.ts"
    inputs:
      - name: rig
        type: entity.rig
      - name: ctx
        type: entity.motion_context
    outputs:
      - name: pose
        type: entity.motion_program
        measures: [bone_count, update_performance, quaternion_validity]
        constraints:
          - "Must implement full gait cycle with proper phase timing"
          - "Must include hip sway with spine counter-rotation"
          - "Must animate all leg bones including toes if available"
          - "Must include fluid arm swing with wrist rotation"
          - "Must keep head stable with slight tilt"
          - "Should use crossover step pattern"
          - "Should include secondary motion for follow-through"

  contemplative_lean:
    type: function
    description: "Thoughtful asymmetric pose with weight on one leg and thinking gestures"
    path: "packages/motion-dsl/src/motions/contemplative-lean.ts"
    inputs:
      - name: rig
        type: entity.rig
      - name: ctx
        type: entity.motion_context
    outputs:
      - name: pose
        type: entity.motion_program
        measures: [bone_count, update_performance, quaternion_validity]
        constraints:
          - "Must implement asymmetric weight distribution"
          - "Must include hand-to-chin or crossed arms pose"
          - "Must animate all finger bones for detailed hand pose"
          - "Must include slow contemplative breathing"
          - "Must add subtle weight shift micro-movements"
          - "Should include thinking gestures (head tilt, eye movement)"
          - "Should support multiple pose variants via parameters"

validators:
  - schema
  - domain
